<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>å°ˆæ¡ˆè¡ŒéŠ·è«‹å‡ç³»çµ±</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: { sans: ['Inter', 'sans-serif'] },
            animation: { 'fade-in-down': 'fadeInDown 0.3s ease-out' },
            keyframes: {
              fadeInDown: {
                '0%': { opacity: '0', transform: 'translateY(-20px)' },
                '100%': { opacity: '1', transform: 'translateY(0)' },
              }
            }
          }
        }
      }
    </script>

    <!-- Babel for in-browser JSX compilation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Import Map: Ensure clean React version -->
    <script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@18.2.0?dev",
    "react-dom/client": "https://esm.sh/react-dom@18.2.0/client?dev",
    "@google/genai": "https://esm.sh/@google/genai",
    "react/": "https://aistudiocdn.com/react@^19.2.1/"
  }
}
</script>

    <style>
      ::-webkit-scrollbar { width: 8px; height: 8px; }
      ::-webkit-scrollbar-track { background: #f1f1f1; }
      ::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 4px; }
      ::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }
    </style>
  </head>
  <body class="bg-slate-50 text-slate-900 font-sans">
    <div id="root"></div>

    <!-- Application Script -->
    <script type="text/babel" data-type="module">
      import React, { useState, useEffect, useContext, createContext } from 'react';
      import ReactDOM from 'react-dom/client';
      import { GoogleGenAI } from "@google/genai";

      // --- Error Boundary ---
      class ErrorBoundary extends React.Component {
        constructor(props) {
          super(props);
          this.state = { hasError: false, error: null };
        }

        static getDerivedStateFromError(error) {
          return { hasError: true, error };
        }

        componentDidCatch(error, errorInfo) {
          console.error("React Error:", error, errorInfo);
        }

        render() {
          if (this.state.hasError) {
            return (
              <div className="min-h-screen flex items-center justify-center bg-slate-50 p-4">
                <div className="bg-white p-8 rounded-lg shadow-xl max-w-lg w-full text-center">
                  <h1 className="text-2xl font-bold text-red-600 mb-4">ç³»çµ±ç™¼ç”ŸéŒ¯èª¤</h1>
                  <p className="text-slate-600 mb-4">å¾ˆæŠ±æ­‰ï¼Œç³»çµ±é‡åˆ°é æœŸå¤–çš„éŒ¯èª¤ã€‚</p>
                  <button 
                    onClick={() => { window.location.reload(); }} 
                    className="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded transition"
                  >
                    é‡æ–°æ•´ç†é é¢
                  </button>
                </div>
              </div>
            );
          }
          return this.props.children;
        }
      }

      // --- 1. CONSTANTS & UTILS ---
      const UserRole = {
        ADMIN: 'ADMIN',
        USER: 'USER',
      };

      const RequestType = {
        OVERTIME: 'OVERTIME',
        LEAVE: 'LEAVE',
      };

      const RequestStatus = {
        PENDING: 'PENDING',
        APPROVED: 'APPROVED',
        REJECTED: 'REJECTED',
      };

      const SEED_ADMIN = {
        id: 'admin-1',
        username: 'admin',
        password: 'admin123',
        role: UserRole.ADMIN,
        compTimeBalance: 0,
      };

      const safeJsonParse = (key, fallback) => {
        try {
          const item = localStorage.getItem(key);
          return item ? JSON.parse(item) : fallback;
        } catch (e) {
          console.error(`Error parsing ${key}`, e);
          return fallback;
        }
      };

      // --- 2. GEMINI SERVICE ---
      const getAiClient = () => {
        let apiKey = '';
        try {
          if (typeof process !== 'undefined' && process.env && process.env.API_KEY) {
            apiKey = process.env.API_KEY;
          } else if (window.API_KEY) {
            apiKey = window.API_KEY;
          }
        } catch (e) {
          // ignore process missing error
        }

        if (!apiKey) return null;
        return new GoogleGenAI({ apiKey });
      };

      const polishReason = async (input, type) => {
        const ai = getAiClient();
        if (!ai) return input;

        const typeText = type === RequestType.OVERTIME ? 'åŠ ç­' : 'è£œä¼‘';
        const prompt = `
          ä½ æ˜¯ä¸€ä½å°ˆæ¥­çš„äººè³‡åŠ©ç†ã€‚è«‹å¹«æˆ‘æ½¤é£¾ä»¥ä¸‹ã€Œ${typeText}ç”³è«‹ã€çš„åŸå› ï¼Œä½¿å…¶èªæ°£æ›´å°ˆæ¥­ã€ç°¡æ½”ä¸”æ¸…æ™°ã€‚
          è«‹ä½¿ç”¨ç¹é«”ä¸­æ–‡ (Traditional Chinese)ã€‚
          ä¸è¦æé€ äº‹å¯¦ï¼Œåƒ…æ”¹å–„èªæ°£å’Œèªæ³•ã€‚
          
          è¼¸å…¥: "${input}"
          
          åªéœ€è¼¸å‡ºæ½¤é£¾å¾Œçš„æ–‡å­—ã€‚
        `;

        try {
          const response = await ai.models.generateContent({
            model: 'gemini-2.5-flash',
            contents: prompt,
          });
          return response.text.trim();
        } catch (error) {
          console.error("Gemini Error:", error);
          return input;
        }
      };

      // --- 3. CONTEXT ---
      const DataContext = createContext();

      const DataProvider = ({ children }) => {
        // Robust Initialization: Read from localStorage ONCE at startup
        const [users, setUsers] = useState(() => {
            const loaded = safeJsonParse('app_users', []);
            let initialUsers = Array.isArray(loaded) ? loaded : [];
            
            // Critical Fix: Ensure Admin Always Exists if list is empty or admin missing
            const adminExists = initialUsers.some(u => u.username === 'admin');
            if (!adminExists) {
                console.log("Admin not found, seeding...");
                initialUsers = [...initialUsers, SEED_ADMIN];
            }
            return initialUsers;
        });
        
        const [requests, setRequests] = useState(() => safeJsonParse('app_requests', []));
        
        const [currentUser, setCurrentUser] = useState(() => {
            const session = safeJsonParse('app_session', null);
            return session;
        });
        
        const [notification, setNotification] = useState(null);

        // Persistence: Save to LocalStorage whenever state changes
        // Using strict dependency arrays to ensure updates are captured
        useEffect(() => {
          if (users.length > 0) {
            localStorage.setItem('app_users', JSON.stringify(users));
          }
        }, [users]);

        useEffect(() => {
          localStorage.setItem('app_requests', JSON.stringify(requests));
        }, [requests]);

        useEffect(() => {
          if (currentUser) {
              localStorage.setItem('app_session', JSON.stringify(currentUser));
              // Ensure session object stays in sync with user database
              const freshUser = users.find(u => u.id === currentUser.id);
              if (freshUser) {
                  // Only update if critical fields changed to avoid loops
                  if(freshUser.compTimeBalance !== currentUser.compTimeBalance || freshUser.role !== currentUser.role) {
                      setCurrentUser(freshUser);
                  }
              } else {
                  // User deleted
                  setCurrentUser(null);
              }
          } else {
              localStorage.removeItem('app_session');
          }
        }, [currentUser, users]);

        const showNotification = (message, type) => {
          setNotification({ message, type });
          setTimeout(() => setNotification(null), 3000);
        };

        const login = (username, pass) => {
          const cleanUser = username.trim();
          const cleanPass = pass.trim();
          
          const user = users.find(u => u.username === cleanUser);
          if (!user) return false;
          
          if (user.password === cleanPass) {
              setCurrentUser(user);
              return true;
          }
          return false;
        };

        const logout = () => {
          setCurrentUser(null);
          localStorage.removeItem('app_session');
        };

        const addUser = (userData) => {
          if (users.some(u => u.username === userData.username)) {
            showNotification('å¸³è™Ÿå·²å­˜åœ¨', 'error');
            return;
          }
          const newUser = { 
              ...userData, 
              username: userData.username.trim(),
              password: userData.password.trim(),
              id: Date.now().toString(), 
              compTimeBalance: 0 
          };
          // Functional update to ensure we have latest state
          setUsers(prev => [...prev, newUser]);
          showNotification('æˆåŠŸå»ºç«‹ä½¿ç”¨è€…', 'success');
        };

        const deleteUser = (id) => {
          setUsers(prev => prev.filter(u => u.id !== id));
          showNotification('ä½¿ç”¨è€…å·²åˆªé™¤', 'success');
        };

        const updatePassword = (id, newPass) => {
          const cleanPass = newPass.trim();
          setUsers(prev => prev.map(u => u.id === id ? { ...u, password: cleanPass } : u));
          showNotification('å¯†ç¢¼æ›´æ–°æˆåŠŸ', 'success');
        };

        const submitRequest = (reqData) => {
          if (!currentUser) return;

          let calculated = parseFloat(reqData.hours);
          if (reqData.type === RequestType.OVERTIME) {
            const day = new Date(reqData.date).getDay();
            if (day === 0 || day === 6) calculated = 8; 
          }

          if (reqData.type === RequestType.LEAVE && currentUser.compTimeBalance < reqData.hours) {
              showNotification('æ‚¨çš„è£œä¼‘é¤˜é¡ä¸è¶³', 'error');
              return;
          }

          const newReq = {
            ...reqData,
            hours: parseFloat(reqData.hours),
            id: Date.now().toString(),
            userId: currentUser.id,
            username: currentUser.username,
            status: RequestStatus.PENDING,
            calculatedHours: calculated,
            createdAt: new Date().toISOString(),
          };

          setRequests(prev => [newReq, ...prev]);
          showNotification('ç”³è«‹å–®å·²é€å‡º', 'success');
        };

        const processRequest = (requestId, status) => {
          const req = requests.find(r => r.id === requestId);
          if (!req) return;

          if (status === RequestStatus.APPROVED) {
            const targetUser = users.find(u => u.id === req.userId);
            if (targetUser) {
              let newBalance = targetUser.compTimeBalance;
              if (req.type === RequestType.OVERTIME) {
                newBalance += req.calculatedHours;
              } else {
                if (newBalance < req.hours) {
                  showNotification('ç”¨æˆ¶é¤˜é¡ä¸è¶³ï¼Œç„¡æ³•æ ¸å‡†', 'error');
                  return;
                }
                newBalance -= req.hours;
              }
              setUsers(prev => prev.map(u => u.id === targetUser.id ? { ...u, compTimeBalance: newBalance } : u));
            }
          }

          setRequests(prev => prev.map(r => r.id === requestId ? { ...r, status } : r));
          const statusText = status === RequestStatus.APPROVED ? 'æ ¸å‡†' : 'æ‹’çµ•';
          showNotification(`å·²${statusText}è©²ç”³è«‹`, 'success');
        };

        return (
          <DataContext.Provider value={{
            users, currentUser, requests, notification, login, logout, addUser, deleteUser, updatePassword, submitRequest, processRequest, showNotification
          }}>
            {children}
          </DataContext.Provider>
        );
      };

      const useData = () => {
        const context = useContext(DataContext);
        if (!context) throw new Error("useData must be used within DataProvider");
        return context;
      };

      // --- 4. COMPONENTS ---

      // Login Component
      const Login = () => {
        const { login } = useData();
        const [username, setUsername] = useState('');
        const [password, setPassword] = useState('');
        const [error, setError] = useState('');
        
        const handleSubmit = (e) => {
          e.preventDefault();
          setError('');
          const success = login(username, password);
          if (!success) {
              setError('å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤ï¼Œè«‹é‡æ–°è¼¸å…¥ã€‚');
          }
        };

        return (
          <div className="min-h-screen bg-slate-100 flex items-center justify-center p-4">
            <div className="bg-white rounded-2xl shadow-xl p-8 w-full max-w-md border border-slate-200">
              <div className="text-center mb-8">
                  <h1 className="text-3xl font-extrabold text-slate-800 tracking-tight">å°ˆæ¡ˆè¡ŒéŠ·è«‹å‡ç³»çµ±</h1>
                  <p className="text-slate-500 mt-2">é«˜æ•ˆç®¡ç†æ‚¨çš„åŠ ç­èˆ‡è£œä¼‘</p>
              </div>
              <form onSubmit={handleSubmit} className="space-y-6">
                <div>
                    <label className="block text-sm font-medium text-slate-700 mb-1">å¸³è™Ÿ</label>
                    <input type="text" required className="w-full px-4 py-3 rounded-lg border border-slate-300 outline-none focus:ring-2 focus:ring-blue-500 bg-slate-50 focus:bg-white transition" value={username} onChange={(e) => setUsername(e.target.value)} placeholder="è¼¸å…¥å¸³è™Ÿ" />
                </div>
                <div>
                    <label className="block text-sm font-medium text-slate-700 mb-1">å¯†ç¢¼</label>
                    <input type="password" required className="w-full px-4 py-3 rounded-lg border border-slate-300 outline-none focus:ring-2 focus:ring-blue-500 bg-slate-50 focus:bg-white transition" value={password} onChange={(e) => setPassword(e.target.value)} placeholder="è¼¸å…¥å¯†ç¢¼" />
                </div>
                
                {error && (
                    <div className="bg-red-50 text-red-600 p-3 rounded-lg text-sm font-medium border border-red-100 flex items-center">
                        <svg className="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20"><path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clipRule="evenodd" /></svg>
                        {error}
                    </div>
                )}

                <button type="submit" className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg shadow-lg transition duration-200">ç™»å…¥</button>
              </form>
              <div className="mt-8 pt-6 border-t border-slate-100 text-center">
                 <p className="text-xs text-slate-400">é è¨­ç®¡ç†å“¡å¸³è™Ÿ: <span className="font-mono text-slate-600">admin</span> / <span className="font-mono text-slate-600">admin123</span></p>
              </div>
            </div>
          </div>
        );
      };

      // Layout
      const Layout = ({ children, activeTab, setActiveTab }) => {
        const { currentUser, logout, notification } = useData();
        const [isMobileMenuOpen, setIsMobileMenuOpen] = useState(false);

        if (!currentUser) return <>{children}</>;
        const isAdmin = currentUser.role === UserRole.ADMIN;
        
        const NavItem = ({ id, label, icon }) => (
          <button onClick={() => { setActiveTab(id); setIsMobileMenuOpen(false); }} className={`flex items-center space-x-3 px-6 py-3 w-full text-left transition-colors duration-200 ${activeTab === id ? 'bg-blue-50 text-blue-700 border-r-4 border-blue-600' : 'text-slate-600 hover:bg-slate-50'}`}>
            <span className="text-xl">{icon}</span>
            <span className="font-medium tracking-wide">{label}</span>
          </button>
        );

        return (
          <div className="min-h-screen bg-slate-100 flex flex-col md:flex-row font-sans">
            {notification && <div className={`fixed top-4 right-4 z-50 px-6 py-3 rounded-lg shadow-lg text-white animate-fade-in-down ${notification.type === 'error' ? 'bg-red-500' : 'bg-green-600'}`}>{notification.message}</div>}
            
            {/* Desktop Sidebar */}
            <aside className="hidden md:flex flex-col w-72 bg-white shadow-xl h-screen sticky top-0 z-10">
              <div className="p-8 border-b border-slate-100">
                <h1 className="text-2xl font-bold text-slate-800">å°ˆæ¡ˆè¡ŒéŠ·</h1>
                <div className="mt-4 flex items-center space-x-3">
                    <div className="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 font-bold">{currentUser.username.charAt(0).toUpperCase()}</div>
                    <div>
                        <p className="text-sm font-bold text-slate-700">{currentUser.username}</p>
                        <p className="text-xs text-slate-500">{isAdmin ? 'ç³»çµ±ç®¡ç†å“¡' : `é¤˜é¡: ${currentUser.compTimeBalance}hr`}</p>
                    </div>
                </div>
              </div>
              <nav className="flex-1 py-6 space-y-1">
                <NavItem id="dashboard" label="å„€è¡¨æ¿" icon="ğŸ“Š" />
                <NavItem id="apply" label="ç”³è«‹åŠ ç­/è£œä¼‘" icon="ğŸ“" />
                {isAdmin && <NavItem id="admin" label="ç®¡ç†å¾Œå°" icon="âš™ï¸" />}
                <NavItem id="settings" label="å€‹äººè¨­å®š" icon="ğŸ‘¤" />
              </nav>
              <div className="p-6 border-t border-slate-100"><button onClick={logout} className="flex items-center justify-center text-red-600 hover:bg-red-50 px-4 py-3 w-full rounded-lg transition font-medium"><span className="mr-2">ğŸšª</span> ç™»å‡ºç³»çµ±</button></div>
            </aside>

            {/* Mobile Header */}
            <div className="md:hidden bg-white shadow-md sticky top-0 z-20">
              <div className="flex justify-between items-center p-4">
                  <div><h1 className="font-bold text-slate-800 text-lg">å°ˆæ¡ˆè¡ŒéŠ·ç³»çµ±</h1><span className="text-xs text-gray-500">é¤˜é¡: {currentUser.compTimeBalance}å°æ™‚</span></div>
                <button onClick={() => setIsMobileMenuOpen(!isMobileMenuOpen)} className="text-slate-600 focus:outline-none text-2xl p-2">â˜°</button>
              </div>
              {isMobileMenuOpen && (
                <div className="bg-slate-50 border-t border-slate-200 animate-fade-in-down shadow-inner">
                   <NavItem id="dashboard" label="å„€è¡¨æ¿" icon="ğŸ“Š" />
                   <NavItem id="apply" label="ç”³è«‹åŠ ç­/è£œä¼‘" icon="ğŸ“" />
                   {isAdmin && <NavItem id="admin" label="ç®¡ç†å¾Œå°" icon="âš™ï¸" />}
                   <NavItem id="settings" label="å€‹äººè¨­å®š" icon="ğŸ‘¤" />
                   <button onClick={logout} className="block w-full text-left px-8 py-4 text-red-600 font-medium border-t border-slate-200">ç™»å‡º</button>
                </div>
              )}
            </div>

            <main className="flex-1 p-4 md:p-8 overflow-y-auto"><div className="max-w-6xl mx-auto">{children}</div></main>
          </div>
        );
      };

      // Dashboard
      const Dashboard = () => {
        const { currentUser, requests } = useData();
        if (!currentUser) return null;
        const myRequests = requests.filter(r => r.userId === currentUser.id);
        const pendingCount = myRequests.filter(r => r.status === RequestStatus.PENDING).length;
        const approvedCount = myRequests.filter(r => r.status === RequestStatus.APPROVED).length;
        
        const getStatusColor = (status) => {
          switch (status) { case RequestStatus.APPROVED: return 'bg-green-100 text-green-800'; case RequestStatus.REJECTED: return 'bg-red-100 text-red-800'; default: return 'bg-yellow-100 text-yellow-800'; }
        };

        return (
          <div className="space-y-6 animate-fade-in-down">
            <h2 className="text-2xl font-bold text-slate-800">æˆ‘çš„å„€è¡¨æ¿</h2>
            <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
              <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-100 hover:shadow-md transition"><p className="text-sm font-medium text-slate-500">ç›®å‰è£œä¼‘é¤˜é¡</p><p className="text-4xl font-bold text-blue-600 mt-2">{currentUser.compTimeBalance} <span className="text-sm font-normal text-slate-400">å°æ™‚</span></p></div>
              <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-100 hover:shadow-md transition"><p className="text-sm font-medium text-slate-500">å¾…å¯©æ ¸ç”³è«‹</p><p className="text-4xl font-bold text-yellow-500 mt-2">{pendingCount}</p></div>
              <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-100 hover:shadow-md transition"><p className="text-sm font-medium text-slate-500">ç¸½æ ¸å‡†æ¬¡æ•¸</p><p className="text-4xl font-bold text-green-500 mt-2">{approvedCount}</p></div>
            </div>
            <div className="bg-white rounded-xl shadow-sm border border-slate-100 overflow-hidden">
              <div className="px-6 py-4 border-b border-slate-100 bg-slate-50/50"><h3 className="text-lg font-semibold text-slate-800">è¿‘æœŸæ´»å‹•ç´€éŒ„</h3></div>
              {myRequests.length === 0 ? <div className="p-12 text-center text-slate-400">ç›®å‰æ²’æœ‰ç´€éŒ„ã€‚</div> : (
                <div className="overflow-x-auto"><table className="w-full text-left text-sm text-slate-600"><thead className="bg-slate-50 text-slate-700 uppercase text-xs font-bold tracking-wider"><tr><th className="px-6 py-3">é¡å‹</th><th className="px-6 py-3">æ—¥æœŸ</th><th className="px-6 py-3">æ™‚æ•¸è®Šå‹•</th><th className="px-6 py-3">ç‹€æ…‹</th><th className="px-6 py-3">åŸå› </th></tr></thead><tbody className="divide-y divide-slate-100">{myRequests.map((req) => (<tr key={req.id} className="hover:bg-slate-50 transition"><td className="px-6 py-4"><span className={`px-2 py-1 rounded text-xs font-bold ${req.type === RequestType.OVERTIME ? 'bg-indigo-100 text-indigo-700' : 'bg-orange-100 text-orange-700'}`}>{req.type === RequestType.OVERTIME ? 'åŠ ç­' : 'è£œä¼‘'}</span></td><td className="px-6 py-4 font-medium text-slate-700">{req.date} <span className="text-slate-400 text-xs ml-1">{req.startTime}</span></td><td className="px-6 py-4 font-medium">{req.type === RequestType.OVERTIME ? <span className="text-green-600">+{req.calculatedHours} hr</span> : <span className="text-red-500">-{req.hours} hr</span>}</td><td className="px-6 py-4"><span className={`px-2 py-1 rounded-full text-xs font-bold ${getStatusColor(req.status)}`}>{req.status === RequestStatus.APPROVED ? 'å·²æ ¸å‡†' : req.status === RequestStatus.REJECTED ? 'å·²æ‹’çµ•' : 'å¾…å¯©æ ¸'}</span></td><td className="px-6 py-4 max-w-xs truncate text-slate-500">{req.reason}</td></tr>))}</tbody></table></div>
              )}
            </div>
          </div>
        );
      };

      // RequestForm
      const RequestForm = () => {
        const { submitRequest, showNotification } = useData();
        const [type, setType] = useState(RequestType.OVERTIME);
        const [date, setDate] = useState('');
        const [startTime, setStartTime] = useState('');
        const [hours, setHours] = useState(0);
        const [reason, setReason] = useState('');
        const [isPolishing, setIsPolishing] = useState(false);

        useEffect(() => {
          if (date) {
            // Default time set to 09:00 for all days
            setStartTime('09:00'); 
          }
        }, [date]);

        const handleDateChange = (e) => {
            const val = e.target.value;
            if (val && type === RequestType.LEAVE) {
                const day = new Date(val).getDay();
                // 0 = Sunday, 6 = Saturday
                if (day === 0 || day === 6) {
                    showNotification('è£œä¼‘åƒ…é™å¹³æ—¥ç”³è«‹ï¼Œå‡æ—¥è«‹ç”³è«‹åŠ ç­ã€‚', 'error');
                    setDate('');
                    return;
                }
            }
            setDate(val);
        };

        const handleTypeChange = (newType) => {
            setType(newType);
            // Re-validate date if switching to LEAVE
            if (newType === RequestType.LEAVE && date) {
                const day = new Date(date).getDay();
                if (day === 0 || day === 6) {
                    setDate(''); // Clear invalid date
                }
            }
        };

        const handleSubmit = (e) => {
          e.preventDefault();
          if (hours <= 0) { showNotification('æ™‚æ•¸å¿…é ˆå¤§æ–¼ 0', 'error'); return; }
          submitRequest({ type, date, startTime, hours, reason });
          setDate(''); setStartTime(''); setHours(0); setReason('');
        };

        const handleAiPolish = async () => {
          if (!reason || reason.length < 2) { showNotification('è«‹å…ˆè¼¸å…¥è‰ç¨¿åŸå› ', 'error'); return; }
          setIsPolishing(true);
          try {
            const polished = await polishReason(reason, type);
            setReason(polished);
            showNotification('AI æ½¤é£¾å®Œæˆï¼', 'success');
          } catch (e) { showNotification('æ½¤é£¾å¤±æ•—', 'error'); } 
          finally { setIsPolishing(false); }
        };

        return (
          <div className="max-w-2xl mx-auto animate-fade-in-down">
            <div className="bg-white rounded-xl shadow-sm border border-slate-100 p-8">
              <h2 className="text-2xl font-bold text-slate-800 mb-8">æ–°å¢ç”³è«‹å–®</h2>
              <form onSubmit={handleSubmit} className="space-y-8">
                <div className="grid grid-cols-2 gap-4 p-1 bg-slate-100 rounded-xl">
                  <button type="button" onClick={() => handleTypeChange(RequestType.OVERTIME)} className={`py-3 px-4 rounded-lg font-bold transition-all ${type === RequestType.OVERTIME ? 'bg-white text-blue-600 shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}>ç”³è«‹åŠ ç­</button>
                  <button type="button" onClick={() => handleTypeChange(RequestType.LEAVE)} className={`py-3 px-4 rounded-lg font-bold transition-all ${type === RequestType.LEAVE ? 'bg-white text-orange-500 shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}>ç”³è«‹è£œä¼‘</button>
                </div>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                  <div>
                      <label className="block text-sm font-bold text-slate-700 mb-2">æ—¥æœŸ</label>
                      <input type="date" required value={date} onChange={handleDateChange} className="w-full rounded-lg border-slate-300 border p-3 outline-none focus:ring-2 focus:ring-blue-500" />
                      {type === RequestType.LEAVE && <p className="text-xs text-orange-500 mt-1">* åƒ…é™å¹³æ—¥</p>}
                  </div>
                  <div>
                    <label className="block text-sm font-bold text-slate-700 mb-2">é–‹å§‹æ™‚é–“</label>
                    <input type="time" required value={startTime} onChange={(e) => setStartTime(e.target.value)} className="w-full rounded-lg border-slate-300 border p-3 outline-none focus:ring-2 focus:ring-blue-500" />
                    <p className="text-xs text-slate-400 mt-2 font-medium">é è¨­æ™‚é–“ï¼š09:00</p>
                  </div>
                </div>
                <div>
                   <label className="block text-sm font-bold text-slate-700 mb-2">æ™‚æ•¸ (å°æ™‚)</label>
                   <input type="number" step="0.5" min="0.5" required value={hours || ''} onChange={(e) => setHours(e.target.value)} className="w-full rounded-lg border-slate-300 border p-3 outline-none focus:ring-2 focus:ring-blue-500" />
                   {type === RequestType.OVERTIME && date && (
                      <div className="mt-3 bg-blue-50 p-3 rounded-lg text-xs text-blue-700 border border-blue-100">
                          <span className="font-bold">è‡ªå‹•è¨ˆç®—è¦å‰‡ï¼š</span>
                          {new Date(date).getDay() % 6 === 0 ? `å‡æ—¥åŠ ç­ä¸€å¾‹æ ¸ç™¼ 8 å°æ™‚è£œä¼‘ã€‚` : `å¹³æ—¥åŠ ç­ä¾å¯¦éš›æ™‚æ•¸æ ¸ç™¼ã€‚`}
                      </div>
                   )}
                </div>
                <div>
                  <label className="block text-sm font-bold text-slate-700 mb-2">ç”³è«‹åŸå› </label>
                  <div className="relative">
                      <textarea required rows={4} value={reason} onChange={(e) => setReason(e.target.value)} placeholder="è«‹ç°¡è¿°åŸå› ..." className="w-full rounded-lg border-slate-300 border p-3 outline-none pr-12 focus:ring-2 focus:ring-blue-500" />
                      <button type="button" onClick={handleAiPolish} disabled={isPolishing} className="absolute bottom-4 right-4 p-2 bg-gradient-to-r from-purple-500 to-indigo-600 text-white rounded-full hover:shadow-lg transition disabled:opacity-50 transform hover:scale-105" title="AI æ½¤é£¾">{isPolishing ? '...' : 'âœ¨'}</button>
                  </div>
                </div>
                <button type="submit" className="w-full bg-slate-900 hover:bg-slate-800 text-white font-bold py-4 px-4 rounded-xl shadow-lg transition duration-200">é€å‡ºç”³è«‹å–®</button>
              </form>
            </div>
          </div>
        );
      };

      // AdminPanel
      const AdminPanel = () => {
        const { users, requests, addUser, deleteUser, updatePassword, processRequest, currentUser } = useData();
        const [view, setView] = useState('requests');
        const [newUsername, setNewUsername] = useState('');
        const [newPassword, setNewPassword] = useState('');
        const [newRole, setNewRole] = useState(UserRole.USER);
        
        if (currentUser?.role !== UserRole.ADMIN) return <div>æ¬Šé™ä¸è¶³</div>;
        const pendingRequests = requests.filter(r => r.status === RequestStatus.PENDING);
        
        const handleCreateUser = (e) => {
          e.preventDefault();
          if(newUsername && newPassword) {
              addUser({ username: newUsername, password: newPassword, role: newRole });
              setNewUsername(''); setNewPassword('');
          }
        };

        return (
          <div className="space-y-6 animate-fade-in-down">
            <div className="flex space-x-2 mb-6 bg-white p-1 rounded-lg inline-flex border border-slate-200">
              <button onClick={() => setView('requests')} className={`px-4 py-2 rounded-md font-bold text-sm transition ${view === 'requests' ? 'bg-slate-800 text-white shadow' : 'bg-transparent text-slate-500 hover:text-slate-800'}`}>å¾…å¯©æ ¸ ({pendingRequests.length})</button>
              <button onClick={() => setView('users')} className={`px-4 py-2 rounded-md font-bold text-sm transition ${view === 'users' ? 'bg-slate-800 text-white shadow' : 'bg-transparent text-slate-500 hover:text-slate-800'}`}>å¸³è™Ÿç®¡ç†</button>
            </div>
            {view === 'requests' && (
              <div className="bg-white rounded-xl shadow-sm border border-slate-100 overflow-hidden">
                   {pendingRequests.length === 0 ? <div className="p-12 text-center text-slate-400">ç›®å‰æ²’æœ‰å¾…å¯©æ ¸ç”³è«‹ã€‚</div> : (
                       <div className="divide-y divide-slate-100">{pendingRequests.map(req => (<div key={req.id} className="p-6 flex flex-col md:flex-row justify-between items-start md:items-center space-y-4 md:space-y-0 hover:bg-slate-50"><div><div className="flex items-center space-x-3"><span className="font-bold text-slate-800 text-lg">{req.username}</span><span className={`px-2 py-1 rounded text-xs font-bold ${req.type === RequestType.OVERTIME ? 'bg-indigo-100 text-indigo-700' : 'bg-orange-100 text-orange-700'}`}>{req.type === RequestType.OVERTIME ? 'åŠ ç­' : 'è£œä¼‘'}</span></div><p className="text-sm text-slate-600 mt-2 font-medium">{req.date} <span className="text-slate-400 mx-1">|</span> {req.startTime} <span className="text-slate-400 mx-1">|</span> ç”³è«‹ {req.hours}å°æ™‚ {req.type === RequestType.OVERTIME && req.calculatedHours !== req.hours && <span className="text-blue-600 font-bold ml-1">â†’ ç³»çµ±å»ºè­° {req.calculatedHours}å°æ™‚</span>}</p><div className="mt-2 bg-slate-50 p-2 rounded text-sm text-slate-600 border border-slate-100 inline-block max-w-xl">"{req.reason}"</div></div><div className="flex space-x-3"><button onClick={() => processRequest(req.id, RequestStatus.APPROVED)} className="bg-green-500 hover:bg-green-600 text-white px-5 py-2 rounded-lg text-sm font-bold transition shadow-sm">æ ¸å‡†</button><button onClick={() => processRequest(req.id, RequestStatus.REJECTED)} className="bg-red-500 hover:bg-red-600 text-white px-5 py-2 rounded-lg text-sm font-bold transition shadow-sm">æ‹’çµ•</button></div></div>))}</div>
                   )}
              </div>
            )}
            {view === 'users' && (
              <div className="space-y-8">
                  <div className="bg-white p-8 rounded-xl shadow-sm border border-slate-100"><h3 className="text-lg font-bold text-slate-800 mb-6">å»ºç«‹æ–°å¸³è™Ÿ</h3><form onSubmit={handleCreateUser} className="flex flex-col md:flex-row gap-4 items-end"><div className="flex-1 w-full"><label className="block text-xs font-bold text-slate-500 mb-2 uppercase tracking-wide">å¸³è™Ÿ</label><input value={newUsername} onChange={e => setNewUsername(e.target.value)} required className="w-full border border-slate-300 p-3 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="User123" /></div><div className="flex-1 w-full"><label className="block text-xs font-bold text-slate-500 mb-2 uppercase tracking-wide">å¯†ç¢¼</label><input value={newPassword} onChange={e => setNewPassword(e.target.value)} required type="password" className="w-full border border-slate-300 p-3 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="******" /></div><div className="w-full md:w-48"><label className="block text-xs font-bold text-slate-500 mb-2 uppercase tracking-wide">æ¬Šé™</label><select value={newRole} onChange={e => setNewRole(e.target.value)} className="w-full border border-slate-300 p-3 rounded-lg bg-white outline-none"><option value={UserRole.USER}>ä¸€èˆ¬ç”¨æˆ¶</option><option value={UserRole.ADMIN}>ç®¡ç†å“¡</option></select></div><button type="submit" className="w-full md:w-auto bg-slate-900 text-white px-8 py-3 rounded-lg font-bold hover:bg-slate-800 transition">æ–°å¢</button></form></div>
                  <div className="bg-white rounded-xl shadow-sm border border-slate-100 overflow-hidden"><table className="w-full text-left text-sm text-slate-600"><thead className="bg-slate-50 border-b border-slate-200"><tr><th className="px-6 py-4 font-bold text-slate-700">å¸³è™Ÿ</th><th className="px-6 py-4 font-bold text-slate-700">è§’è‰²</th><th className="px-6 py-4 font-bold text-slate-700">é¤˜é¡</th><th className="px-6 py-4 text-right font-bold text-slate-700">æ“ä½œ</th></tr></thead><tbody className="divide-y divide-slate-100">{users.map(u => (<tr key={u.id} className="hover:bg-slate-50"><td className="px-6 py-4 font-bold text-slate-800">{u.username}</td><td className="px-6 py-4"><span className={`text-xs px-2 py-1 rounded font-bold ${u.role === UserRole.ADMIN ? 'bg-purple-100 text-purple-700' : 'bg-slate-100 text-slate-600'}`}>{u.role === UserRole.ADMIN ? 'ç®¡ç†å“¡' : 'ä¸€èˆ¬ç”¨æˆ¶'}</span></td><td className="px-6 py-4 font-mono">{u.compTimeBalance} hr</td><td className="px-6 py-4 text-right space-x-4"><button onClick={() => { const newP = prompt('è«‹è¼¸å…¥æ–°å¯†ç¢¼:'); if(newP) updatePassword(u.id, newP); }} className="text-blue-600 hover:text-blue-800 font-medium">é‡è¨­å¯†ç¢¼</button>{u.id !== currentUser.id && <button onClick={() => { if(confirm('ç¢ºå®šè¦åˆªé™¤?')) deleteUser(u.id); }} className="text-red-500 hover:text-red-700 font-medium">åˆªé™¤</button>}</td></tr>))}</tbody></table></div>
              </div>
            )}
          </div>
        );
      };

      // Settings
      const Settings = () => {
        const { currentUser, updatePassword, showNotification } = useData();
        const [password, setPassword] = useState('');
        const [confirm, setConfirm] = useState('');
        if (!currentUser) return null;
        const handleUpdate = (e) => {
          e.preventDefault();
          if (password !== confirm) { showNotification("å¯†ç¢¼ä¸ç¬¦", 'error'); return; }
          updatePassword(currentUser.id, password); setPassword(''); setConfirm('');
        };
        return (
          <div className="max-w-md mx-auto animate-fade-in-down">
            <div className="bg-white rounded-xl shadow-sm border border-slate-100 p-8">
              <h2 className="text-xl font-bold text-slate-800 mb-6">å¸³è™Ÿå®‰å…¨è¨­å®š</h2>
              <form onSubmit={handleUpdate} className="space-y-6">
                <div><label className="block text-sm font-bold text-slate-700 mb-2">æ–°å¯†ç¢¼</label><input type="password" required value={password} onChange={e => setPassword(e.target.value)} className="w-full border border-slate-300 p-3 rounded-lg outline-none focus:ring-2 focus:ring-blue-500" placeholder="è«‹è¼¸å…¥æ–°å¯†ç¢¼" /></div>
                <div><label className="block text-sm font-bold text-slate-700 mb-2">ç¢ºèªæ–°å¯†ç¢¼</label><input type="password" required value={confirm} onChange={e => setConfirm(e.target.value)} className="w-full border border-slate-300 p-3 rounded-lg outline-none focus:ring-2 focus:ring-blue-500" placeholder="å†æ¬¡è¼¸å…¥" /></div>
                <button className="w-full bg-slate-900 text-white py-4 rounded-lg font-bold hover:bg-slate-800 transition">æ›´æ–°å¯†ç¢¼</button>
              </form>
            </div>
          </div>
        );
      };

      // --- 5. MAIN APP ---
      const AppContent = () => {
        const { currentUser } = useData();
        const [activeTab, setActiveTab] = useState('dashboard');
        if (!currentUser) return <Login />;
        
        const renderContent = () => {
          switch (activeTab) {
            case 'dashboard': return <Dashboard />;
            case 'apply': return <RequestForm />;
            case 'admin': return <AdminPanel />;
            case 'settings': return <Settings />;
            default: return <Dashboard />;
          }
        };
        return <Layout activeTab={activeTab} setActiveTab={setActiveTab}>{renderContent()}</Layout>;
      };

      const App = () => (
        <DataProvider>
            <ErrorBoundary>
                <AppContent />
            </ErrorBoundary>
        </DataProvider>
      );

      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<App />);
    </script>
  </body>
</html>